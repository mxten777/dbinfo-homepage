// ğŸ” Firebase ë³´ì•ˆ ê·œì¹™ (Firestore)
// ì´ íŒŒì¼ì„ Firebase Console > Firestore > ê·œì¹™ì— ì ìš©í•˜ì„¸ìš”

rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ğŸ¯ ê´€ë¦¬ì ê³„ì • ë³´ì•ˆ
    match /admins/{adminId} {
      // ì½ê¸°: ì¸ì¦ëœ ê´€ë¦¬ìë§Œ
      allow read: if isAdmin();
      // ì“°ê¸°: ìŠˆí¼ ê´€ë¦¬ìë‚˜ ìê¸° ìì‹ ë§Œ (ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë“±)
      allow write: if isSuperAdmin() || (isAdmin() && resource.data.email == request.auth.token.email);
    }
    
    // ğŸ‘¥ ì§ì› ì •ë³´ ë³´ì•ˆ
    match /employees/{employeeId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” ë³¸ì¸ë§Œ
      allow read: if isAdmin() || isOwner(employeeId);
      // ìƒì„±: ê´€ë¦¬ìë§Œ
      allow create: if isAdmin();
      // ìˆ˜ì •: ê´€ë¦¬ìë§Œ (ì§ì›ì€ ì¼ë¶€ í•„ë“œë§Œ ìˆ˜ì • ê°€ëŠ¥í•˜ë„ë¡ ë³„ë„ ê·œì¹™)
      allow update: if isAdmin() || (isOwner(employeeId) && isValidEmployeeUpdate());
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ğŸ“‹ ì—°ì°¨ ì‹ ì²­ ë³´ì•ˆ
    match /leaves/{leaveId} {
      // ì½ê¸°: ê´€ë¦¬ì ë˜ëŠ” ì‹ ì²­ì ë³¸ì¸
      allow read: if isAdmin() || request.auth.uid == resource.data.employeeId;
      // ìƒì„±: ì¸ì¦ëœ ì§ì› (ë³¸ì¸ ì‹ ì²­ë§Œ)
      allow create: if request.auth != null && 
                   request.auth.uid == request.resource.data.employeeId &&
                   isValidLeaveRequest();
      // ìˆ˜ì •: ê´€ë¦¬ìë§Œ (ìƒíƒœ ë³€ê²½) ë˜ëŠ” ì‹ ì²­ì ë³¸ì¸ (pending ìƒíƒœì¼ ë•Œë§Œ)
      allow update: if isAdmin() || 
                   (request.auth.uid == resource.data.employeeId && 
                    resource.data.status == 'pending' && 
                    isValidLeaveUpdate());
      // ì‚­ì œ: ê´€ë¦¬ì ë˜ëŠ” ì‹ ì²­ì ë³¸ì¸ (pending ìƒíƒœì¼ ë•Œë§Œ)
      allow delete: if isAdmin() || 
                   (request.auth.uid == resource.data.employeeId && 
                    resource.data.status == 'pending');
    }
    
    // ğŸ”„ ëŒ€ë¦¬ì‹ ì²­ ë³´ì•ˆ
    match /deputyRequests/{requestId} {
      // ì½ê¸°: ê´€ë¦¬ìë§Œ
      allow read: if isAdmin();
      // ìƒì„±: ê´€ë¦¬ìë§Œ
      allow create: if isAdmin() && isValidDeputyRequest();
      // ìˆ˜ì •: ê´€ë¦¬ìë§Œ
      allow update: if isAdmin();
      // ì‚­ì œ: ê´€ë¦¬ìë§Œ
      allow delete: if isAdmin();
    }
    
    // ğŸ—ï¸ íšŒì‚¬ ì†Œì‹ ë³´ì•ˆ
    match /companyNews/{newsId} {
      // ì½ê¸°: ëª¨ë“  ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if request.auth != null;
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
    }
    
    // ğŸ“Š í”„ë¡œì íŠ¸ ìƒíƒœ ë³´ì•ˆ
    match /projects/{projectId} {
      // ì½ê¸°: ì¸ì¦ëœ ì‚¬ìš©ì
      allow read: if request.auth != null;
      // ì“°ê¸°: ê´€ë¦¬ìë§Œ
      allow write: if isAdmin();
    }
    
    // â›” ê¸°ë³¸ì ìœ¼ë¡œ ëª¨ë“  ë‹¤ë¥¸ ê²½ë¡œ ì°¨ë‹¨
    match /{document=**} {
      allow read, write: if false;
    }
    
    // ğŸ›¡ï¸ ë³´ì•ˆ í•¨ìˆ˜ë“¤
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return request.auth != null && 
             request.auth.token.email != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }
    
    function isSuperAdmin() {
      return isAdmin() && 
             get(/databases/$(database)/documents/admins/$(request.auth.uid)).data.role == 'super';
    }
    
    function isOwner(resourceId) {
      return request.auth != null && request.auth.uid == resourceId;
    }
    
    function isValidEmployeeUpdate() {
      // ì§ì›ì´ ìˆ˜ì • ê°€ëŠ¥í•œ í•„ë“œë§Œ í—ˆìš©
      let allowedFields = ['name', 'contact', 'password'];
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasAll(allowedFields.toSet());
    }
    
    function isValidLeaveRequest() {
      let data = request.resource.data;
      return data.keys().hasAll(['employeeId', 'employeeName', 'startDate', 'endDate', 'reason', 'type', 'days']) &&
             data.startDate is timestamp &&
             data.endDate is timestamp &&
             data.days is number && data.days > 0 &&
             data.reason is string && data.reason.size() > 0 &&
             data.type in ['ì—°ì°¨', 'ë°˜ì°¨', 'ë³‘ê°€', 'ê²½ì¡°ì‚¬'] &&
             data.status == 'pending';
    }
    
    function isValidLeaveUpdate() {
      // ì§ì›ì€ pending ìƒíƒœì¼ ë•Œë§Œ ì‚¬ìœ , ë‚ ì§œ ìˆ˜ì • ê°€ëŠ¥
      let allowedFields = ['reason', 'startDate', 'endDate', 'days'];
      return request.resource.data.diff(resource.data).affectedKeys()
        .hasAll(allowedFields.toSet()) &&
        request.resource.data.status == 'pending';
    }
    
    function isValidDeputyRequest() {
      let data = request.resource.data;
      return data.keys().hasAll(['targetEmployeeId', 'startDate', 'endDate', 'reason', 'requestedBy']) &&
             data.startDate is timestamp &&
             data.endDate is timestamp &&
             data.reason is string && data.reason.size() > 0 &&
             data.requestedBy == request.auth.uid;
    }
  }
}